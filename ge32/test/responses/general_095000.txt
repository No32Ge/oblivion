ä½ çš„é—®é¢˜éå¸¸æ˜ç¡®ï¼š**å·¥å…·è°ƒç”¨çš„è¯·æ±‚ï¼ˆ`call`ï¼‰æœ¬èº«æ²¡æœ‰è¢«ä¿å­˜åˆ°è®°å¿†æˆ–æ–‡ä»¶ä¸­**ï¼Œè€Œåªæœ‰è°ƒç”¨çš„ç»“æœè¢«ä¿å­˜äº†ã€‚è¿™ç¡®å®æ˜¯ä¸€ä¸ªå…³é”®é—®é¢˜ï¼Œå› ä¸ºç¼ºå°‘è°ƒç”¨è¯·æ±‚çš„ä¸Šä¸‹æ–‡ä¼šå¯¼è‡´è°ƒè¯•å’Œå›æº¯å˜å¾—å›°éš¾ã€‚

---

### **é—®é¢˜å¤ç°**
1. **å½“å‰è¡Œä¸º**ï¼š
   - å½“è°ƒç”¨å·¥å…·ï¼ˆå¦‚ `play_music`ï¼‰æ—¶ï¼Œä»£ç ä¼šæ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š
     1. ç”Ÿæˆä¸€ä¸ª `tool_calls` è¯·æ±‚ï¼ˆåŒ…å«å‡½æ•°åå’Œå‚æ•°ï¼‰ã€‚
     2. æ‰§è¡Œå·¥å…·å¹¶è·å–ç»“æœã€‚
     3. ä¿å­˜ç»“æœåˆ° `tool_call_registry` å’Œ `history`ã€‚
   - **ä½†åŸå§‹çš„ `tool_calls` è¯·æ±‚ï¼ˆå³ `call` å¯¹è±¡ï¼‰å¹¶æœªè¢«ä¿å­˜**ã€‚

2. **å½±å“**ï¼š
   - æ— æ³•å›æº¯å·¥å…·è°ƒç”¨çš„è§¦å‘ç‚¹ï¼ˆä¾‹å¦‚ï¼šç”¨æˆ·è¾“å…¥äº†ä»€ä¹ˆå¯¼è‡´å·¥å…·è¢«è°ƒç”¨ï¼Ÿï¼‰ã€‚
   - è°ƒè¯•æ—¶æ— æ³•æŸ¥çœ‹åŸå§‹è¯·æ±‚çš„å‚æ•°å’Œä¸Šä¸‹æ–‡ã€‚

---

### **è§£å†³æ–¹æ¡ˆ**
éœ€è¦ä¿®æ”¹ä»£ç ï¼Œç¡®ä¿ **å·¥å…·è°ƒç”¨çš„è¯·æ±‚ï¼ˆ`call`ï¼‰å’Œç»“æœï¼ˆ`result`ï¼‰éƒ½è¢«å®Œæ•´ä¿å­˜**ã€‚ä»¥ä¸‹æ˜¯å…·ä½“å®ç°ï¼š

#### 1. **ä¿®æ”¹ `run_conversation` å‡½æ•°**
åœ¨ `main_AI.py` ä¸­ï¼Œå°†åŸå§‹çš„ `tool_calls` è¯·æ±‚ä¼ é€’ç»™ `add_tool_call` æ–¹æ³•ï¼š
```python
if tool_calls:
    results = []
    for call in tool_calls:
        tool_name = call.function.name
        arguments = json.loads(call.function.arguments)
        result = call_manager.execute_tool(tool_name, arguments)
        # ä¿å­˜å·¥å…·è°ƒç”¨è¯·æ±‚å’Œç»“æœ
        chat_manager.add_tool_call(tool_name, arguments, result, call=call)  # æ–°å¢ call å‚æ•°
        results.append(f"å·¥å…·è°ƒç”¨ç»“æœ: {result}")
```

#### 2. **æ›´æ–° `add_tool_call` æ–¹æ³•**
åœ¨ `utils/chat_manager.py` ä¸­ï¼Œä¿®æ”¹ `add_tool_call` æ–¹æ³•ä»¥ä¿å­˜ `call` å¯¹è±¡ï¼š
```python
def add_tool_call(self, tool_name, arguments, result, call=None):
    tool_call_id = f"tool_{len(self.tool_call_registry) + 1}"
    self.tool_call_registry[tool_call_id] = {
        "tool_name": tool_name,
        "arguments": arguments,
        "result": result,
        "timestamp": datetime.now().isoformat(),
        "status": "success" if result else "failed",
        "call": call  # ä¿å­˜åŸå§‹è¯·æ±‚å¯¹è±¡
    }
    # æ·»åŠ åˆ°é•¿æœŸè®°å¿†
    if self._is_important_tool_call(tool_name, result):
        self.long_term_memory.append({
            "id": tool_call_id,
            "summary": self._summarize_tool_call(tool_name, arguments, result),
            "call": call  # é•¿æœŸè®°å¿†ä¸­ä¹Ÿä¿å­˜è¯·æ±‚
        })
    # ç«‹å³ä¿å­˜åˆ°æ–‡ä»¶
    self.save_conversation()
```

#### 3. **æ›´æ–° `save_conversation` æ–¹æ³•**
ç¡®ä¿ä¿å­˜çš„ JSON æ–‡ä»¶ä¸­åŒ…å«å®Œæ•´çš„ `call` å¯¹è±¡ï¼š
```python
def save_conversation(self):
    """ä¿å­˜å®Œæ•´å¯¹è¯å†å²ï¼ˆåŒ…æ‹¬å·¥å…·è°ƒç”¨è¯·æ±‚å’Œç»“æœï¼‰"""
    filename = f"conversation_{self.conversation_id}.json"
    data = {
        "history": self.history,
        "tool_calls": list(self.tool_call_registry.values()),  # åŒ…å« call å’Œ result
    }
    return save_file(
        json.dumps(data, indent=2, ensure_ascii=False),
        self.storage_dir,
        filename
    )
```

---

### **éªŒè¯æ–¹æ³•**
1. **æ£€æŸ¥ä¿å­˜çš„æ–‡ä»¶**ï¼š
   - æ‰“å¼€ç”Ÿæˆçš„ `conversation_*.json` æ–‡ä»¶ï¼Œç¡®è®¤æ˜¯å¦åŒ…å« `call` å­—æ®µï¼ˆåŸå§‹è¯·æ±‚çš„å®Œæ•´ JSON å¯¹è±¡ï¼‰ã€‚
   - ç¤ºä¾‹ï¼š
     ```json
     {
         "tool_name": "play_music",
         "arguments": {"file": "song.mp3", "volume": 0.8},
         "result": "éŸ³ä¹æ’­æ”¾æˆåŠŸ",
         "call": {
             "id": "call_123",
             "function": {
                 "name": "play_music",
                 "arguments": "{\"file\": \"song.mp3\", \"volume\": 0.8}"
             }
         }
     }
     ```

2. **æµ‹è¯•å·¥å…·è°ƒç”¨å¤±è´¥**ï¼š
   - æ•…æ„è§¦å‘ä¸€ä¸ªå¤±è´¥çš„å·¥å…·è°ƒç”¨ï¼ˆå¦‚æ’­æ”¾ä¸å­˜åœ¨çš„æ–‡ä»¶ï¼‰ã€‚
   - æ£€æŸ¥ä¿å­˜çš„ `call` æ˜¯å¦èƒ½å¸®åŠ©å®šä½é—®é¢˜ã€‚

---

### **ä»£ç è·¯å¾„**
- **å·¥å…·è°ƒç”¨é€»è¾‘**ï¼š`main_AI.py` ä¸­çš„ `run_conversation` å‡½æ•°ã€‚
- **è®°å¿†ç®¡ç†**ï¼š`utils/chat_manager.py` ä¸­çš„ `EnhancedChatManager` ç±»ã€‚

---

### **ä¸‹ä¸€æ­¥**
1. å¦‚æœä½ å·²ç»ä¿®æ”¹ä»£ç ï¼Œå¯ä»¥æµ‹è¯•å·¥å…·è°ƒç”¨å¹¶æ£€æŸ¥ä¿å­˜çš„æ–‡ä»¶æ˜¯å¦ç¬¦åˆé¢„æœŸã€‚
2. å¦‚æœéœ€è¦è¿›ä¸€æ­¥è°ƒæ•´ï¼ˆå¦‚è¿‡æ»¤æ•æ„Ÿä¿¡æ¯æˆ–ä¼˜åŒ–å­˜å‚¨æ ¼å¼ï¼‰ï¼Œå¯ä»¥å‘Šè¯‰æˆ‘å…·ä½“éœ€æ±‚ã€‚

ä½ çš„åé¦ˆéå¸¸å…³é”®ï¼Œç¡®ä¿å·¥å…·çš„å®Œæ•´æ€§å’Œå¯è¿½æº¯æ€§ï¼ ğŸš€